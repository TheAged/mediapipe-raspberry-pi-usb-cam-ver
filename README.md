# 使用 MediaPipe Pose 實現即時跌倒偵測

本專案使用 Google 的 MediaPipe Pose 函式庫及 Python 的 OpenCV，實作了一個基礎的即時跌倒偵測系統。它分析來自視訊流（網路攝影機或影片檔案）的人體姿態關節點，以根據運動學與位置線索來識別潛在的跌倒事件。

## 專案描述

此腳本擷取視訊畫面，透過 MediaPipe Pose 處理以獲得 33 個人體 3D 關節點，接著應用一套規則來判斷是否發生了跌倒。偵測邏輯考量了以下幾點：

1.  **垂直速度 (Vertical Velocity):** 追蹤人體臀部中心的向下速度。速度快速增加可能表示正在跌落。
2.  **身體方向 (Body Orientation):** 計算軀幹（肩膀中心到臀部中心連線）相對於垂直線的角度。長時間維持較大的角度表示身體處於水平姿態，這在跌倒後很常見。
3.  **相對高度 (Relative Height):** 監控臀部中心的垂直位置（Y 座標）相對於畫面高度的比例。若位置接近畫面底部邊緣，可能表示躺臥或坐在地上。
4.  **狀態持續性 (State Persistence):** 要求潛在的跌倒指標（如高速下降或水平/低高度姿態）持續達到預設的時長 (`FALL_CONFIRM_DURATION`) 後，才確認為跌倒，藉此減少因短暫快速動作引起的誤報。

腳本會繪製偵測到的姿態骨架，並在輸出的視訊視窗上顯示目前的偵測狀態（「正常」、「疑似跌倒...」、「偵測到跌倒！」），以提供視覺回饋。

## 主要功能

* 透過 MediaPipe Pose 進行即時姿態估計。
* 基於垂直速度、身體角度和相對高度的跌倒偵測。
* 時間濾波（狀態持續性）以提升穩定性。
* 包含骨架疊加與狀態訊息的視覺化輸出。
* 簡易 FPS（畫面更新率）顯示。
* 鍵盤控制：按下 'q' 鍵退出，按下 'r' 鍵重設跌倒狀態。
* 可配置的偵測閾值。

## 環境需求

* Python 3.7+
* OpenCV (`opencv-python`)
* MediaPipe (`mediapipe`)
* NumPy (`numpy`)

## 安裝指南

1.  **複製儲存庫或下載腳本。**
2.  **（選擇性但建議）建立並啟用 Python 虛擬環境：**
    ```bash
    python3 -m venv venv
    # Linux/macOS:
    source venv/bin/activate
    # Windows:
    # venv\Scripts\activate
    ```
3.  **安裝必要的函式庫：**
    ```bash
    pip install opencv-python mediapipe numpy
    ```

## 使用方法

1.  **連接網路攝影機**或準備好影片檔案的路徑。
2.  **從您的終端機執行腳本：**
    ```bash
    python3 your_script_name.py
    ```
    *（請將 `your_script_name.py` 替換為您實際的腳本檔名，例如 `falldect_mediapipe.py`）*
3.  腳本將開啟一個視窗，顯示包含姿態關節點和偵測狀態的視訊畫面。
4.  **互動操作：**
    * 按下 **'q'** 鍵退出應用程式。
    * 按下 **'r'** 鍵可在測試過程中手動將「偵測到跌倒！」狀態重設回「正常」。

*注意：腳本預設使用索引值為 `0` 的網路攝影機。若要使用不同的攝影機或影片檔案，請修改腳本中的 `cv2.VideoCapture()` 行。*

## 設定與調整 (非常重要)

跌倒偵測的準確性**高度依賴**於腳本中設定的閾值。這些閾值**必須**根據您的具體設置和環境進行調整：

* `Y_VELOCITY_THRESHOLD`: 控制臀部向下移動的速度要多快才會觸發疑似跌倒。如果過於敏感，請**增加**此值；如果遺漏跌倒，請**減小**此值。
* `ANGLE_THRESHOLD`: 決定身體被視為「水平」的角度（相對於垂直線）。如果輕微傾斜就被誤判，請**增加**此值；如果水平倒下卻未觸發，請**減小**此值。
* `HEIGHT_THRESHOLD_FACTOR`: 定義臀部要多低（相對於畫面高度，0.0=頂部, 1.0=底部）才算「過低」。根據攝影機視角和使用者通常的位置調整此值（Y 座標大於此值表示過低）。
* `FALL_CONFIRM_DURATION`: 疑似跌倒狀態必須持續多久（秒）才會被確認。**增加**此值以避免將短暫動作（如撿東西）誤判為跌倒；**減小**此值以加快確認速度。
* `model_complexity` (在 `mp_pose.Pose` 中設定): 可設為 `0` (lite)、`1` (full) 或 `2` (heavy)。數值越低執行速度越快，但準確度可能較低，尤其在像樹莓派這樣資源有限的裝置上。

**在您的目標環境中針對這些數值進行實驗對於獲得可靠的效能至關重要。**

## 已知限制

* **閾值依賴性：** 效能對所選閾值非常敏感。
* **環境因素：** 準確性可能受攝影機角度、距離、光線條件和背景雜亂程度影響。
* **遮擋：** 如果關鍵身體部位（尤其是臀部、肩膀）被遮擋，偵測可能會失敗。
* **模糊動作：** 可能會將實際跌倒與類似的刻意動作混淆，例如快速躺下、某些運動（如波比跳）或突然坐下。
* **效能：** 即時處理可能需要大量計算資源，尤其是在資源受限的裝置上。如果 FPS 過低，請調整 `model_complexity`。
* **多人場景：** 目前腳本假設畫面中只有一個人，未明確處理多人情況。


